---
title: "Battery SOC Estimator Interactive Web Simulation"
description: "Explore battery State-of-Charge estimation in your browser using a Fixed-Gain Observer or Kalman Filter."
image: "../../assets/soc_estimator/soc_estimator.png"
lightbox: true
---

## Overview

Estimating battery State of Charge (SOC) is used every day in our battery powered devices. However, it's impractical to directly measure how much charge a battery has. One approach to this problem is the combination of a Luenberger Observer and a battery model that correlates Open Current Voltage (VOC) and State of Charge (SOC). The Luenberger Observer starts with a guess of the battery state of charge, and as it makes repeated measurements of VOC, it adjusts its SOC prediction until it converges to the true behavior measured by the battery estimator. This approach is effective if the behavior of the true battery is well understood, and if SOC can be observable by VOC. 

One challenge with battery estimation is that sometimes the VOC-SOC curve has "plateaus" such that similar VOCs correspond drastically different SOCs, making the SOC effectively unobservable by VOC alone. 

The effectiveness of the observer also depends on the accuracy of the model. As shown in the simulation, the estimator will not converge to the true SOC if the estimator's model is different than the actual behavior (using the linear approximation vs true SOC curve). 

Different battery chemistries and physical properties have distinctive curves as show in Jeff Shepard's article [fantastic article](https://www.batterypowertips.com/how-to-read-battery-discharge-curves-faq/).

Environmental factors such as temperature and the formation of dendrites as the battery ages means the "true" model can evolve dynamically overtime, so maintaining an accurate SOC estimate requires the estimator model to also evolve accurately with the true behavior.

## Simulation
<iframe src="https://austlin.shinyapps.io/battery_estimator/" 
        width="100%" 
        height="800" 
        style="border:1px solid #ccc;">
</iframe>


### True Battery SOC and VOC Model

The battery is modeled as an RC pair with a series resistance of 0.05 Ω and a capacity of 7920 coulombs. These parameters correspond roughly to a typical 2200 mAh lithium-ion cell, which operates at approximately 3.6 V[^1][^2]. The initial state-of-charge (SOC) estimate is set to 50%.  

The true battery voltage and the estimated voltage share the same functional form, but are computed using their respective SOC values. Gaussian measurement noise is applied to both voltage and current readings, with standard deviations of 100 mV and 10 mA, respectively. The SOC is updated over time by integrating the applied current divided by the battery capacity.



**True Voltage/SOC Curve:**  
$$
V_\text{OCV, nonlinear}(SOC) = 2.6 + 2.35 \, SOC - 3.75 \, SOC^2 + 2.5 \, SOC^3
$$

**Linear Approximation of Cubic Model:**  
$$
V_\text{OCV, linear}(SOC) = 2.6 + 1.1 \, SOC
$$

**Battery State-Space Model:**

$$
\dot{SOC}(t) = \frac{I(t)}{Q}, \quad
V_\text{true}(t) = V_\text{OCV}(SOC(t)) + R_s \, I(t)
$$

- $I(t)$ : Discrete time step index  
- $R_s$ : Internal Battery Resistance (set as 0.05 Ohm )
- $Q$ : Battery Capacity (set as 2200 mAh or 7920 C)

---

### SOC Estimator

The SOC estimator follows a similar structure to the true model, with measurement noise added to the current to simulate sensor readings. A feedback term is applied, proportional to the difference between measured voltage and estimated voltage. This difference is scaled by the observer gain $K$ (for the Luenberger observer) or by the Kalman gain (for the KF), which determines the corrective strength.

$$
\dot{\hat{SOC}}(t) = \frac{I(t) + n_I}{Q} + K \left( V_\text{true}(t) + n_V - \hat{V}(t) \right)
$$

$$
\hat{V}(t) = V_\text{OCV}(\hat{SOC}(t)) + R_s \left(I(t) + n_I(t)\right)
$$

- $\hat{SOC}(t)$ : Estimated SOC  
- $\hat{V}(t)$ : Estimated voltage  
- $n_I$ : Current Noise
- $n_V$ : Voltage Noise
- $K$ : Observer gain

## Results

When the true VOC–SOC model is used for the estimator, the SOC estimate converges smoothly to the true SOC despite measurement noise. Quantitatively, under a 0.5 A discharge, the SOC error is approximately 4.7% at 8.3 minutes, while at a higher 2.2 A charge/discharge rate the error is about 4.4% at 500 seconds. After 500 seconds, the observer consistently estimates the true SOC within 5% under nominal conditions. In contrast, when the linear VOC–SOC approximation is used, the estimator remains close to the true SOC but fails to fully converge except at points where the linear and cubic models intersect. Adding noise does not alter this behavior since the difference between the models is not random.

Additionally, when using the true model, increasing the fixed observer gain reduces convergernce time to true SOC; however, excessively large gains introduce increased noise in the estimate. The Kalman filter converges to the true SOC significantly faster than the fixed-gain observer, but careful tuning of the process and measurement noise covariances is required to minimize estimate noise. Smaller initial SOC errors—particularly when starting closer to the true SOC in depleted battery conditions—further improve convergence behavior.

[^1]: [Tenergy 18650 Li-ion Battery](https://power.tenergy.com/tenergy-li-ion-18650-cylindrical-3-6v-2200mah-flat-top-rechargeable-battery-ul-listed/)  
[^2]: [Adafruit 18650 Li-ion Battery](https://www.adafruit.com/product/1781)
